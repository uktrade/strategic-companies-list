{% load static %}
{% load svg_tags %}
<!DOCTYPE html>
<html lang="en" class="govuk-template scl-template">

<head>
  <meta charset="utf-8">
  <title>Strategic Companies List - Department for Business and Trade</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#0b0c0c">
  <link rel="icon" sizes="48x48" href="{% static 'images/favicon.ico' %}">
  <link rel="icon" sizes="any" href="{% static 'images/favicon.svg' %}" type="image/svg+xml">
  <link rel="mask-icon" href="{% static 'images/govuk-icon-mask.svg' %}" color="#0b0c0c">
  <link rel="apple-touch-icon" href="{% static 'images/govuk-icon-180.png' %}">
  <link rel="manifest" href="{% static 'manifest.json' %}">
  <link rel="stylesheet" href="{% static 'govuk-frontend.min.css' %}">
  <link rel="stylesheet" href="{% static 'scl.css' %}">
</head>

<body class="govuk-template__body">
  <script nonce="{{request.csp_nonce}}">
    document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');
  </script>
  <a href="#main-content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>
  <header class="govuk-header govuk-header--full-width-border scl-header--full-width-border" data-module="govuk-header">
    <div class="govuk-header__container govuk-width-container scl-header__container scl-header__full-width_container">
      <div class="govuk-header__logo scl-header__logo">
        <a href="/" class="govuk-header__link govuk-header__link--homepage scl-header__link">
          {% svg 'dbt-logo' %}
          <span class="govuk-header__product-name scl-header__product-name">
            Strategic Companies List
          </span>
        </a>
        <strong class="govuk-tag govuk-tag--red scl-tag scl-tag--security scl-header__security-classification scl-header__security-classification--long">
          OFFICIAL-SENSITIVE
        </strong>
        <strong class="govuk-tag govuk-tag--red scl-tag scl-tag--security scl-header__security-classification scl-header__security-classification--short">
          OFF-SEN
        </strong>
      </div>
    </div>
  </header>
 
  {% block content %}{% endblock %}

  <footer class="govuk-footer scl-footer">
    <div class="govuk-width-container">
      <div class="govuk-footer__meta">
        <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">
          {% svg 'ogl' %}
          <span class="govuk-footer__licence-description">
            All content is available under the
            <a
              class="govuk-footer__link"
              href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
              rel="license">Open Government Licence v3.0</a>, except where otherwise stated
          </span>
        </div>
        <div class="govuk-footer__meta-item">
          <a
            class="govuk-footer__link govuk-footer__copyright-logo"
            href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/">
            Â© Crown copyright
          </a>
        </div>
      </div>
    </div>
  </footer>
  <script type="module" src="{% static 'govuk-frontend.min.js' %}"></script>
  <script type="module" nonce="{{request.csp_nonce}}">
    import {
      initAll
    } from '{% static 'govuk-frontend.min.js' %}'
    initAll()
  </script>
  <script src="{% static 'bundle.js' %}"></script>
  <script nonce="{{request.csp_nonce}}">
  (() => {
    const registerEditButton = (editButton) => {
      const editableSection = Array.from(document.querySelectorAll(editButton.getAttribute("data-scl-edit-button-target")));

      let isEditable = false

      const toggleEdit = async () => {
        isEditable = !isEditable;
        endpoint = editButton.getAttribute('data-scl-endpoint');
        editButton.innerHTML = (isEditable) ? "Save" : "Edit";
        editableSection.map((item) => {
          item.toggleAttribute('contenteditable', isEditable)
        });

        // Only try to save it it's not editable, i.e. we're saving
        if (isEditable) return;

        editButton.disabled = true;
        editButton.innerHTML = "Saving...";

        const data = {}
        editableSection.forEach((item) => {
          data[item.getAttribute('data-scl-editable-field')] = item.innerHTML
        });

        const {error, response} = await minTimeFetch(750, endpoint, {
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          method: "PATCH",
          body: JSON.stringify(data),
        })

        editButton.innerHTML = error ? 'Error!' : 'Saved';
        await timeout(750);

        editButton.disabled = false;
        editButton.innerHTML = "Edit";
      };

      editButton.addEventListener("click", toggleEdit);
    };

    const registerSaveTranscriptButton = (button)=>{
      targetId = button.getAttribute('data-transcript-target');
      endPoint = button.getAttribute('data-scl-endpoint');

      const saveTranscript = async ()=>{
        button.innerHTML = "Saving...";
        data = document.querySelector(`#transcription-target-${targetId} p span`).innerHTML;
        const { error, response } = await minTimeFetch(750, endPoint, {
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          method: "POST",
          body: JSON.stringify({"note": data}),
        })

        button.innerHTML = error ? 'Error!' : 'Saved';
        await timeout(750);
        window.location.reload();
      }


       button.addEventListener("click", saveTranscript);
    }

    const registerDeleteTranscriptButton = (button)=>{
      noteId = button.getAttribute('data-scl-notes-id');
      endPoint = button.getAttribute('data-scl-endpoint');
      const deleteNote = async ()=>{
        button.innerHTML = "Deleting...";
        const {error, response} = await minTimeFetch(750, endPoint, {
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          method: "DELETE",
          body: JSON.stringify({"id": noteId}),
        })

        button.innerHTML = error ? 'Error!' : 'Deleted';
        await timeout(750);
        window.location.reload();
      }


       button.addEventListener("click", deleteNote);
    }

    const timeout = (duration) => {
        return new Promise(resolve => setTimeout(resolve, duration));
      }

    const minTimeFetch = async (minTime, resource, options) => {
        // Wraps fetch in an API where it has a minimum run time (in case it's really quick so
        // the user has a chance to see "Saving" or similar, and also avoids it from raising an
        // exception, so calling code doesn't need try/catch blocks
        const start = performance.now();
        let error = null;
        let response = null;

        try {
          response = await fetch(resource, options);
          if (!response.ok) {
            throw new Error();
          }
          ok = true;
        } catch (_error) {
          error = _error
        }

        const end = performance.now();
        await timeout(Math.max(750, performance.now() - start));

        return {error, response}
      }

    const registerPrintButton = (button) => {
      button.addEventListener("click", () => window.print());
    };

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('[data-module="scl-edit-button"]').forEach(registerEditButton);
      document.querySelectorAll('[data-module="scl-save-transcript"]').forEach(registerSaveTranscriptButton);
      document.querySelectorAll('[data-module="scl-delete-transcript"]').forEach(registerDeleteTranscriptButton);
      document.querySelectorAll('[data-module="scl-print-button"]').forEach(registerPrintButton);
    });
  })();
</script>
</body>

</html>
