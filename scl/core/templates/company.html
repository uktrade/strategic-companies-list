{% extends "base.html" %}
{% load bleach_tags %}
{% load humanize %}
{% load scl_html %}

{% block content %}
<div class="govuk-width-container">
  <nav class="govuk-breadcrumbs" aria-label="Breadcrumb">
    <ol class="govuk-breadcrumbs__list">
      <li class="govuk-breadcrumbs__list-item">
        <a class="govuk-breadcrumbs__link" href="/">Home</a>
      </li>
      <li class="govuk-breadcrumbs__list-item">
        {{company.name}}
      </li>
    </ol>
  </nav>
  <main class="govuk-main-wrapper" id="main-content">
    {% if request.GET.success %}
    <div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
      <div class="govuk-notification-banner__header">
        <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
          Success
        </h2>
      </div>
      <div class="govuk-notification-banner__content">
        <p class="govuk-notification-banner__heading">
          Your changes have been saved
        </p>
      </div>
    </div>
    {% endif %}
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        {% include './partials/header.html' with edit=True edit_endpoint=edit_endpoint title=company.name add_engagement_link=add_engagement_link id=company.id %}
        <p class="govuk-body govuk-body-s govuk-!-margin-bottom-1">D-U-N-S: {{ company.duns_number }}{% if company.global_hq_name %}, {{ company.global_hq_name}}{% endif %}</p>
        {% if company.sectors %}
        <p class="govuk-body govuk-body-s govuk-!-margin-bottom-1">Sectors: {{ company.get_sectors_display }}</p>
        {% endif %}
        <p class="govuk-body govuk-body-s" id="company-last-updated">Last updated: {{ current_version.revision.date_created|date:"j F Y, g:i a" }}</p>
      </div>
    </div>
    <div class="govuk-grid-row">
      <section class="govuk-grid-column-two-thirds">
        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-!-margin-top-0">
        {% if company.global_hq_country or company.global_turnover_millions_usd or global_number_of_employees.global_number_of_employees %}
        <h2 class="govuk-heading-m">Key facts</h2>
        <ul class="govuk-list govuk-list--bullet">
          {% if company.global_hq_country %}
          <li>Headquartered in {{ company.get_global_hq_country_display }}</li>
          {% endif %}
          {% if company.global_turnover_millions_usd %}
          <li>Has global turnover of {% if company.global_turnover_millions_usd > 1000 %}${{ company.global_turnover_billions_usd |floatformat:1|intcomma }} billion{% else %}${{ company.global_turnover_millions_usd |intcomma }} million{% endif %}</li>
          {% endif %}
          {% if company.global_number_of_employees %}
          <li>Employs {{ company.global_number_of_employees|intcomma }} people globally</li>
          {% endif %}
        </ul>
        {% endif %}
        <h2 class="govuk-heading-m">Key People</h2>
        <ul class="govuk-list govuk-list--bullet scl-editable" data-scl-edit-source="editable-content" data-scl-payload="key_people">
          {% if company.key_people %}
          {{ company.key_people | ensure_li | bleach | safe }}
          {% else %}
          <li>No key people information available.</li>
          {% endif %}
        </ul>
        {% if is_privileged %}
        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-section-break--visible govuk-!-margin-top-7 govuk-!-margin-bottom-0">
        <strong class="govuk-tag govuk-tag--red scl-tag scl-tag--security scl-tag--hanging">PRIVILEGED</strong>
        <h2 class="govuk-heading-m govuk-!-margin-top-3">Company Priorities</h2>

        <div id="company-priorities-container" data-company-duns="{{ company.duns_number }}" data-insight-type="company_priority">
          {% if company_priorities %}
          <ul class="govuk-list" id="company-priorities-list">
            {% for priority in company_priorities %}
            <li class="scl-priority-item{% if forloop.counter > 5 %} scl-priority-item--beyond-initial hidden{% endif %}" data-priority-id="{{ priority.id }}">
              <div class="scl-priority-content">
                <b class="scl-priority-title">{{ priority.title }}</b>
                <div class="scl-priority-details">{{ priority.details|linebreaks }}</div>
                <p class="govuk-body-s govuk-!-margin-top-1">
                  Added by {{ priority.created_by.first_name }} {{ priority.created_by.last_name }} on {{ priority.created_at|date:"j M Y" }}
                </p>
              </div>
              <div class="scl-priority-actions scl-priority-actions--hidden">
                <button class="govuk-button govuk-button--secondary scl-button-edit-priority">Edit</button>
                <button class="govuk-button govuk-button--warning scl-button-delete-priority">Delete</button>
              </div>
            </li>
            {% endfor %}
            {% if company_priorities|length > 5 %}
            <li class="scl-priority-more-toggle" data-more-text="Show all priorities" data-less-text="Show fewer priorities">
              <button class="govuk-button govuk-button--secondary">Show all priorities</button>
            </li>
            {% endif %}
          </ul>
          <p class="govuk-body" id="no-company-priorities-message" hidden>No company priorities have been set.</p>
          {% else %}
          <p class="govuk-body" id="no-company-priorities-message">No company priorities have been set.</p>
          {% endif %}

          <button id="add-company-priority-button" class="govuk-button govuk-!-margin-top-2 scl-priority-button--hidden" hidden>
            Add company priority
          </button>
        </div>

        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-section-break--visible govuk-!-margin-top-7 govuk-!-margin-bottom-0">
        <strong class="govuk-tag govuk-tag--red scl-tag scl-tag--security scl-tag--hanging">PRIVILEGED</strong>
        <h2 class="govuk-heading-m govuk-!-margin-top-3">HMG Priorities</h2>

        <div id="hmg-priorities-container" data-company-duns="{{ company.duns_number }}" data-insight-type="hmg_priority">
          {% if hmg_priorities %}
          <ul class="govuk-list" id="hmg-priorities-list">
            {% for priority in hmg_priorities %}
            <li class="scl-priority-item{% if forloop.counter > 5 %} scl-priority-item--beyond-initial hidden{% endif %}" data-priority-id="{{ priority.id }}">
              <div class="scl-priority-content">
                <b class="scl-priority-title">{{ priority.title }}</b>
                <div class="scl-priority-details">{{ priority.details|linebreaks }}</div>
                <p class="govuk-body-s govuk-!-margin-top-1">
                  Added by {{ priority.created_by.first_name }} {{ priority.created_by.last_name }} on {{ priority.created_at|date:"j M Y" }}
                </p>
              </div>
              <div class="scl-priority-actions scl-priority-actions--hidden">
                <button class="govuk-button govuk-button--secondary scl-button-edit-priority">Edit</button>
                <button class="govuk-button govuk-button--warning scl-button-delete-priority">Delete</button>
              </div>
            </li>
            {% endfor %}
            {% if hmg_priorities|length > 5 %}
            <li class="scl-priority-more-toggle" data-more-text="Show all priorities" data-less-text="Show fewer priorities">
              <button class="govuk-button govuk-button--secondary">Show all priorities</button>
            </li>
            {% endif %}
          </ul>
          <p class="govuk-body" id="no-hmg-priorities-message" hidden>No HMG priorities have been set.</p>
          {% else %}
          <p class="govuk-body" id="no-hmg-priorities-message">No HMG priorities have been set.</p>
          {% endif %}

          <button id="add-hmg-priority-button" class="govuk-button govuk-!-margin-top-2 scl-priority-button--hidden" hidden>
            Add HMG priority
          </button>
        </div>
        {% endif %}
      </section>
      <aside class="govuk-grid-column-one-third" role="complementary">
        <hr class="govuk-section-break govuk-section-break--m govuk-!-margin-top-0 govuk-section-break--visible govuk-!-margin-bottom-0">
        {% if is_privileged %}
        <strong class="govuk-tag govuk-tag--red scl-tag scl-tag--security scl-tag--hanging">PRIVILEGED</strong>
        <h2 class="govuk-heading-s govuk-!-margin-top-4 govuk-!-margin-bottom-2">
          Recent top-level engagements across HMG
        </h2>
        <ul class="scl-multiline-list govuk-!-margin-bottom-2">
          {% if past_engagements %}
          {% for engagement in past_engagements %}
          <li>
            <a href="/engagement/{{engagement.id}}" class="govuk-link govuk-link--no-visited-state scl-multiline-list__link">
              <strong class="govuk-tag govuk-tag--grey govuk-!-font-tabular-numbers scl-tag scl-tag--small scl-tag--date scl-multiline-list__date">{{engagement.date}}</strong>
              <span class="scl-multiline-list__link_text">{{engagement.title}}</span>
            </a>
          </li>
          {% endfor %}
          {% else %}
          <p class="govuk-body">No current engagements.</p>
          {% endif %}
        </ul>

        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-!-margin-top-1 govuk-!-margin-bottom-1">
        <p class="govuk-body govuk-!-margin-top-0 govuk-!-margin-bottom-0 scl-body--small"><a href="/company-briefing/{{ company.duns_number }}/engagements" class="govuk-link govuk-link--no-visited-state scl-link--no-underline">View working-level engagements</a></p>
        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-!-margin-top-5 govuk-!-margin-bottom-2">
        {% endif %}
        <h2 class="govuk-heading-s govuk-!-margin-bottom-2 govuk-!-margin-top-{% if is_privileged %}2{% else %}4{% endif %}">Account managers</h2>
        {% if account_managers_with_lead %}
        <ul class="govuk-list scl-list--small">
          {% for account_manager, is_lead in account_managers_with_lead %}
          <li>
            <div class="scl-key-list__item_header">
              <a class="govuk-link govuk-link--no-visited-state scl-link--no-underline" href="##">{{ account_manager.first_name }} {{ account_manager.last_name }}</a>
              {% if is_lead %}
              <strong class="govuk-tag govuk-tag--turquoise scl-tag scl-tag--small govuk-!-static-margin-left-1">Lead</strong>
              {% endif %}
            </div>
          </li>
          {% endfor %}
        </ul>
        {% else %}
        <p class="govuk-body govuk-!-margin-top-0 govuk-!-margin-bottom-0 scl-body--small">No account managers</p>
        {% endif %}
      </aside>
    </div>
  </main>
</div>

<script nonce="{{request.csp_nonce}}">
  (() => {

    const token = document.querySelector("[data-scl-csrf-token]").getAttribute("data-scl-csrf-token");

    // Utility functions
    const timeout = (duration) => new Promise(resolve => setTimeout(resolve, duration));

    const minTimeFetch = async (minTime, resource, options) => {
      const start = performance.now();
      let error = null;
      let response = null;

      try {
        response = await fetch(resource, options);
        if (!response.ok) {
          throw new Error();
        }
      } catch (_error) {
        error = _error;
      }

      const end = performance.now();
      await timeout(Math.max(750, performance.now() - start));

      return { error, response };
    };

    // Helper function to safely create DOM elements
    const createElement = (tag, attributes = {}, children = []) => {
      const element = document.createElement(tag);

      // Set attributes
      Object.entries(attributes).forEach(([key, value]) => {
        if (key === 'className') {
          element.className = value;
        } else if (key === 'textContent') {
          element.textContent = value;
        } else if (key === 'hidden') {
          if (value) element.setAttribute('hidden', '');
        } else {
          element.setAttribute(key, value);
        }
      });

      // Append children
      children.forEach(child => {
        if (typeof child === 'string') {
          element.appendChild(document.createTextNode(child));
        } else {
          element.appendChild(child);
        }
      });

      return element;
    };

    // Update the last updated timestamp
    const updateLastUpdated = () => {
      const lastUpdatedElement = document.getElementById('company-last-updated');
      if (lastUpdatedElement) {
        const now = new Date();
        const month = now.toLocaleString('en-US', { month: 'long' });
        const day = now.getDate();
        const year = now.getFullYear();
        const hour = now.getHours() % 12 || 12;
        const minute = now.getMinutes().toString().padStart(2, '0');
        const ampm = now.getHours() >= 12 ? 'p.m.' : 'a.m.';

        lastUpdatedElement.textContent = `Last updated: ${day} ${month} ${year}, ${hour}:${minute} ${ampm}`;
     }
    };

    // Global editing state
    let pageIsEditing = false;

    // Toggle priority actions visibility based on edit mode
    const editButton = document.querySelector('[data-module="scl-edit-button"]');
    if (editButton) {
      const priorityActions = document.querySelectorAll('.scl-priority-actions');
      const addButtons = document.querySelectorAll('.scl-priority-button--hidden');
      const moreToggles = document.querySelectorAll('.scl-priority-more-toggle');

      // Show "Show more" toggle buttons only when not in edit mode
      const updatePriorityVisibility = () => {
        const priorityActions = document.querySelectorAll('.scl-priority-actions');
        const addButtons = document.querySelectorAll('.scl-priority-button--hidden');
        const moreToggles = document.querySelectorAll('.scl-priority-more-toggle');

        priorityActions.forEach(action => {
          action.classList.toggle('scl-priority-actions--hidden', !pageIsEditing);
        });

        addButtons.forEach(button => {
          button.toggleAttribute('hidden', !pageIsEditing);
        });

        // When editing, show all priorities
        if (pageIsEditing) {
          // Hide all "Show more" toggles
          moreToggles.forEach(toggle => {
            toggle.toggleAttribute('hidden', true);
          });

          // Make all priorities visible
          document.querySelectorAll('.scl-priority-item').forEach(item => {
            item.toggleAttribute('hidden', false);
          });
        } else {
          // When not editing, manage "Show more" toggles
          refreshPriorityDisplay();
        }
      };

      // Function to refresh priority display based on current state
      const refreshPriorityDisplay = () => {
        const containers = ['#company-priorities-container', '#hmg-priorities-container'];

        containers.forEach(containerSelector => {
          const container = document.querySelector(containerSelector);
          if (!container) return;

          const list = container.querySelector('.govuk-list');
          const noMessage = container.querySelector('[id^="no-"][id$="-priorities-message"]');

          // If there's no list but should be (we have items), create it
          if (!list && container.querySelectorAll('.scl-priority-item').length > 0) {
            const newList = document.createElement('ul');
            newList.id = containerSelector.replace('#', '') + '-list';
            newList.className = 'govuk-list';

            // Move all priority items into the list
            const items = container.querySelectorAll('.scl-priority-item');
            items.forEach(item => newList.appendChild(item));

            // Add the list to the container
            const addButton = container.querySelector('[id^="add-"][id$="-priority-button"]');
            if (addButton) {
              container.insertBefore(newList, addButton);
            } else {
              container.appendChild(newList);
            }

            // Hide "no priorities" message
            if (noMessage) {
              noMessage.toggleAttribute('hidden', true);
            }
            return;
          }

          if (!list) return;

          const items = list.querySelectorAll('.scl-priority-item');
          const moreToggle = list.querySelector('.scl-priority-more-toggle');

          // Update "no priorities" message visibility
          if (noMessage) {
            noMessage.toggleAttribute('hidden', items.length > 0);
          }

          // If we have no items, remove the list
          if (items.length === 0) {
            list.remove();
            return;
          }

          // Remove any existing "Show more" toggle
          if (moreToggle) {
            moreToggle.remove();
          }

          // If we have more than 5 priorities, add the toggle and hide extras
          if (items.length > 5) {
            // Hide priorities beyond the first 5
            items.forEach((item, index) => {
              if (index >= 5) {
                item.classList.add('scl-priority-item--beyond-initial');
                item.toggleAttribute('hidden', true);
              } else {
                item.classList.remove('scl-priority-item--beyond-initial');
                item.toggleAttribute('hidden', false);
              }
            });

            // Create and add the "Show more" toggle
            const newToggle = document.createElement('li');
            newToggle.className = 'scl-priority-more-toggle';
            newToggle.dataset.moreText = 'Show all priorities';
            newToggle.dataset.lessText = 'Show fewer priorities';

            const toggleButton = document.createElement('button');
            toggleButton.className = 'govuk-button govuk-button--secondary';
            toggleButton.textContent = 'Show all priorities';
            newToggle.appendChild(toggleButton);

            // Insert after the 5th item
            if (items[4] && items[4].nextSibling) {
              list.insertBefore(newToggle, items[4].nextSibling);
            } else {
              list.appendChild(newToggle);
            }

            // Add toggle functionality
            const button = newToggle.querySelector('button');
            let isExpanded = false;

            button.addEventListener('click', () => {
              isExpanded = !isExpanded;
              button.textContent = isExpanded ? newToggle.dataset.lessText : newToggle.dataset.moreText;

              // Show/hide priorities beyond the first 5
              items.forEach((item, index) => {
                if (index >= 5) {
                  item.toggleAttribute('hidden', !isExpanded);
                }
              });
            });
          } else {
            // Show all priorities if we have 5 or fewer
            items.forEach(item => {
              item.toggleAttribute('hidden', false);
            });
          }
        });
      };

      // Initialize priority visibility
      updatePriorityVisibility();

      // Listen for edit button clicks
      editButton.addEventListener('click', () => {
        pageIsEditing = !pageIsEditing;
        updatePriorityVisibility();

        // Force refresh all priority items to update their visibility state
        document.querySelectorAll('.scl-priority-actions').forEach(action => {
          action.classList.toggle('scl-priority-actions--hidden', !pageIsEditing);
        });

        // Update the last updated timestamp when saving
        if (!pageIsEditing) {
          updateLastUpdated();

          // Check each container for empty priority lists and update messages
          ['#company-priorities-container', '#hmg-priorities-container'].forEach(selector => {
            const container = document.querySelector(selector);
            if (!container) return;

            const list = container.querySelector('.govuk-list');
            const noMessage = container.querySelector('[id^="no-"][id$="-priorities-message"]');

            // If list exists but has no items, or doesn't exist, show the message
            if ((!list || list.querySelectorAll('.scl-priority-item').length === 0) && noMessage) {
              noMessage.toggleAttribute('hidden', false);
              if (list) list.remove();
            }
          });

          // Then refresh the overall display
          refreshPriorityDisplay();
        }
      });
    }

    // Handle Company Priorities
    const setupPriorityHandlers = (containerSelector, type) => {
      const container = document.querySelector(containerSelector);
      if (!container) return;

      const duns = container.getAttribute('data-company-duns');
      const insightType = container.getAttribute('data-insight-type');

      const listId = `${insightType.replace('_', '-')}-list`;
      const noMessageId = `no-${insightType.replace('_', '-')}-message`;
      const addButtonId = `add-${insightType.replace('_', '-')}-button`;

      const list = document.getElementById(listId);
      const noMessage = document.getElementById(noMessageId);
      const addButton = document.getElementById(addButtonId);

      // Add new priority
      addButton.addEventListener('click', () => {
        // Hide "no priorities" message when adding a new priority
        if (noMessage) {
          noMessage.toggleAttribute('hidden', true);
        }

        // Create or get list
        let priorityList = container.querySelector('.govuk-list');
        if (!priorityList) {
            priorityList = document.createElement('ul');
            priorityList.id = listId;
            priorityList.className = 'govuk-list';
            container.insertBefore(priorityList, addButton);
        }

        // Create a new priority item at the end of the list
        const newItem = document.createElement('li');
        newItem.className = 'scl-priority-item scl-priority-item--new';

        // Generate a temporary ID for the new item
        const tempId = 'new-priority-' + Date.now();
        newItem.setAttribute('data-temp-id', tempId);

        // Create the form elements
        const editingDiv = createElement('div', { className: 'scl-priority-editing' });

        // Title field
        const titleGroup = createElement('div', { className: 'govuk-form-group' });
        const titleLabel = createElement('label', {
          className: 'govuk-label',
          for: `${tempId}-title`
        }, ['Priority']);
        const titleInput = createElement('input', {
          className: 'govuk-input',
          id: `${tempId}-title`,
          name: 'title',
          type: 'text'
        });

        titleGroup.appendChild(titleLabel);
        titleGroup.appendChild(titleInput);

        // Details field
        const detailsGroup = createElement('div', { className: 'govuk-form-group' });
        const detailsLabel = createElement('label', {
          className: 'govuk-label',
          for: `${tempId}-details`
        }, ['Details']);
        const detailsTextarea = createElement('textarea', {
          className: 'govuk-textarea',
          id: `${tempId}-details`,
          name: 'details',
          rows: '5'
        });

        detailsGroup.appendChild(detailsLabel);
        detailsGroup.appendChild(detailsTextarea);

        // Buttons
        const buttonGroup = createElement('div', { className: 'govuk-button-group' });
        const saveButton = createElement('button', {
          className: 'govuk-button scl-priority-save'
        }, ['Save']);
        const cancelButton = createElement('button', {
          className: 'govuk-button govuk-button--secondary scl-priority-cancel'
        }, ['Cancel']);

        buttonGroup.appendChild(saveButton);
        buttonGroup.appendChild(cancelButton);

        // Assemble the form
        editingDiv.appendChild(titleGroup);
        editingDiv.appendChild(detailsGroup);
        editingDiv.appendChild(buttonGroup);

        newItem.appendChild(editingDiv);
        priorityList.appendChild(newItem);

        // Scroll to the new item
        newItem.scrollIntoView({ behavior: 'smooth', block: 'center' });

        // Focus the title input
        setTimeout(() => {
          titleInput.focus();
        }, 100);

        // Setup save/cancel handlers
        setupNewPriorityHandlers(newItem, duns, insightType);
      });

      // Setup handlers for a new priority item
      const setupNewPriorityHandlers = (item, duns, insightType) => {
        const saveButton = item.querySelector('.scl-priority-save');
        const cancelButton = item.querySelector('.scl-priority-cancel');
        const titleInput = item.querySelector('input[name="title"]');
        const detailsInput = item.querySelector('textarea[name="details"]');

        // Cancel adding
        cancelButton.addEventListener('click', () => {
          item.remove();

          // Check if this was the only item and show "no priorities" message if needed
          const listElement = document.getElementById(listId);
          if (listElement && listElement.querySelectorAll('.scl-priority-item').length === 0) {
            listElement.remove();
            if (noMessage) {
              noMessage.toggleAttribute('hidden', false);
            }
          }
        });

        // Save new priority
        saveButton.addEventListener('click', async () => {
          const title = titleInput.value.trim();
          const details = detailsInput.value.trim();

          if (!title) {
            alert('Please enter a title for the priority');
            return;
          }

          saveButton.textContent = 'Saving...';
          saveButton.disabled = true;

          const endpoint = `/api/v1/company/${duns}/insights/${insightType}`;

          const { error, response } = await minTimeFetch(750, endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': token
            },
            body: JSON.stringify({ title, details })
          });

          if (error) {
            saveButton.textContent = 'Error!';
            await timeout(750);
            saveButton.textContent = 'Save';
            saveButton.disabled = false;
            return;
          }

          const data = await response.json();

          // Replace editing form with the saved priority content
          item.setAttribute('data-priority-id', data.id);
          item.removeAttribute('data-temp-id');
          item.classList.remove('scl-priority-item--new');

          // Clear existing content
          while (item.firstChild) {
            item.removeChild(item.firstChild);
          }

          // Create the content elements
          const contentDiv = createElement('div', { className: 'scl-priority-content' });

          // Title
          const titleElement = createElement('b', {
            className: 'scl-priority-title'
          }, [data.title]);

          // Details with line breaks
          const detailsElement = createElement('div', { className: 'scl-priority-details' });
          data.details.split('\n').forEach((line, index, array) => {
            detailsElement.appendChild(document.createTextNode(line));
            if (index < array.length - 1) {
              detailsElement.appendChild(document.createElement('br'));
            }
          });

          // Author info
          const authorInfo = createElement('p', {
            className: 'govuk-body-s govuk-!-margin-top-1'
          }, [`Added by ${data.created_by} on ${new Date(data.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`]);

          contentDiv.appendChild(titleElement);
          contentDiv.appendChild(detailsElement);
          contentDiv.appendChild(authorInfo);

          // Action buttons
          const actionsDiv = createElement('div', {
            className: `scl-priority-actions ${!pageIsEditing ? 'scl-priority-actions--hidden' : ''}`
          });

          const editButton = createElement('button', {
            className: 'govuk-button govuk-button--secondary scl-button-edit-priority'
          }, ['Edit']);

          const deleteButton = createElement('button', {
            className: 'govuk-button govuk-button--warning scl-button-delete-priority'
          }, ['Delete']);

          actionsDiv.appendChild(editButton);
          actionsDiv.appendChild(deleteButton);

          item.appendChild(contentDiv);
          item.appendChild(actionsDiv);

          // Add event listeners to the new buttons
          setupItemEventListeners(item);

          // Hide "no priorities" message if it exists
          if (noMessage) {
            noMessage.toggleAttribute('hidden', true);
          }

          // Refresh the priority display
          refreshPriorityDisplay();

          // Update the last updated timestamp
          updateLastUpdated();
        });
      };

      // Setup edit/delete buttons for a priority item
      const setupItemEventListeners = (item) => {
        const editButton = item.querySelector('.scl-button-edit-priority');
        const deleteButton = item.querySelector('.scl-button-delete-priority');
        const priorityId = item.getAttribute('data-priority-id');

        // Edit priority in place
        editButton.addEventListener('click', async () => {
          // Get current content
          const titleElement = item.querySelector('.scl-priority-title');
          const detailsElement = item.querySelector('.scl-priority-details');

          const currentTitle = titleElement.textContent.trim();
          // Get text content with newlines preserved
          let currentDetails = '';
          if (detailsElement) {
            // Extract text and preserve line breaks
            Array.from(detailsElement.childNodes).forEach(node => {
              if (node.nodeType === Node.TEXT_NODE) {
                currentDetails += node.textContent;
              } else if (node.nodeName === 'BR') {
                currentDetails += '\n';
              }
            });
          }

          // Save original DOM structure
          item.setAttribute('data-original-structure', 'saved');
          // Store the original elements for later restore
          const origContent = item.cloneNode(true);

          // Clear the item
          while (item.firstChild) {
            item.removeChild(item.firstChild);
          }

          // Create editing form
          const editingDiv = createElement('div', { className: 'scl-priority-editing' });

          // Title field
          const titleGroup = createElement('div', { className: 'govuk-form-group' });
          const titleLabel = createElement('label', {
            className: 'govuk-label',
            for: `edit-${priorityId}-title`
          }, ['Priority']);
          const titleInput = createElement('input', {
            className: 'govuk-input',
            id: `edit-${priorityId}-title`,
            name: 'title',
            type: 'text',
            value: currentTitle
          });

          titleGroup.appendChild(titleLabel);
          titleGroup.appendChild(titleInput);

          // Details field
          const detailsGroup = createElement('div', { className: 'govuk-form-group' });
          const detailsLabel = createElement('label', {
            className: 'govuk-label',
            for: `edit-${priorityId}-details`
          }, ['Details']);
          const detailsTextarea = createElement('textarea', {
            className: 'govuk-textarea',
            id: `edit-${priorityId}-details`,
            name: 'details',
            rows: '5'
          });
          detailsTextarea.textContent = currentDetails.trim();

          detailsGroup.appendChild(detailsLabel);
          detailsGroup.appendChild(detailsTextarea);

          // Buttons
          const buttonGroup = createElement('div', { className: 'govuk-button-group' });
          const saveButton = createElement('button', {
            className: 'govuk-button scl-priority-update'
          }, ['Save']);
          const cancelButton = createElement('button', {
            className: 'govuk-button govuk-button--secondary scl-priority-cancel-edit'
          }, ['Cancel']);

          buttonGroup.appendChild(saveButton);
          buttonGroup.appendChild(cancelButton);

          // Assemble the form
          editingDiv.appendChild(titleGroup);
          editingDiv.appendChild(detailsGroup);
          editingDiv.appendChild(buttonGroup);

          item.appendChild(editingDiv);

          // Setup save/cancel handlers for editing
          const updateButton = item.querySelector('.scl-priority-update');

          // Cancel editing
          cancelButton.addEventListener('click', () => {
            // Restore original content by replacing the entire item
            while (item.firstChild) {
              item.removeChild(item.firstChild);
            }

            // Clone each child node from the original content
            Array.from(origContent.childNodes).forEach(node => {
              item.appendChild(node.cloneNode(true));
            });

            item.removeAttribute('data-original-structure');

            // Re-setup event listeners
            setupItemEventListeners(item);
          });

          // Update priority
          updateButton.addEventListener('click', async () => {
            const title = titleInput.value.trim();
            const details = detailsTextarea.value.trim();

            if (!title) {
              alert('Please enter a title for the priority');
              return;
            }

            updateButton.textContent = 'Saving...';
            updateButton.disabled = true;

            const endpoint = `/api/v1/insights/${priorityId}`;

            const { error, response } = await minTimeFetch(750, endpoint, {
              method: 'PATCH',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': token
              },
              body: JSON.stringify({ title, details })
            });

            if (error) {
              updateButton.textContent = 'Error!';
              await timeout(750);
              updateButton.textContent = 'Save';
              updateButton.disabled = false;
              return;
            }

            const data = await response.json();

            // Clear current content
            while (item.firstChild) {
              item.removeChild(item.firstChild);
            }

            // Create the content elements
            const contentDiv = createElement('div', { className: 'scl-priority-content' });

            // Title
            const titleElement = createElement('b', {
              className: 'scl-priority-title'
            }, [data.title]);

            // Details with line breaks
            const detailsElement = createElement('div', { className: 'scl-priority-details' });
            data.details.split('\n').forEach((line, index, array) => {
              detailsElement.appendChild(document.createTextNode(line));
              if (index < array.length - 1) {
                detailsElement.appendChild(document.createElement('br'));
              }
            });

            // Author info
            const authorInfo = createElement('p', {
              className: 'govuk-body-s govuk-!-margin-top-1'
            }, [`Added by ${data.created_by} on ${new Date(data.created_at).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' })}`]);

            contentDiv.appendChild(titleElement);
            contentDiv.appendChild(detailsElement);
            contentDiv.appendChild(authorInfo);

            // Action buttons
            const actionsDiv = createElement('div', {
              className: `scl-priority-actions ${!pageIsEditing ? 'scl-priority-actions--hidden' : ''}`
            });

            const editButton = createElement('button', {
              className: 'govuk-button govuk-button--secondary scl-button-edit-priority'
            }, ['Edit']);

            const deleteButton = createElement('button', {
              className: 'govuk-button govuk-button--warning scl-button-delete-priority'
            }, ['Delete']);

            actionsDiv.appendChild(editButton);
            actionsDiv.appendChild(deleteButton);

            item.appendChild(contentDiv);
            item.appendChild(actionsDiv);

            // Re-setup event listeners
            setupItemEventListeners(item);

            // Update the last updated timestamp
            updateLastUpdated();
          });
        });

        // Delete priority
        deleteButton.addEventListener('click', async () => {
          if (!confirm('Are you sure you want to delete this priority?')) {
            return;
          }

          deleteButton.textContent = 'Deleting...';
          deleteButton.disabled = true;

          const { error } = await minTimeFetch(750, `/api/v1/insights/${priorityId}`, {
            method: 'DELETE',
            headers: {
              'X-CSRFToken': token
            }
          });

          if (error) {
            deleteButton.textContent = 'Error!';
            await timeout(750);
            deleteButton.textContent = 'Delete';
            deleteButton.disabled = false;
            return;
          }

          // Remove item from UI
          item.remove();

          // Check if list is now empty
          const listElement = document.getElementById(listId);
          if (listElement && listElement.querySelectorAll('.scl-priority-item').length === 0) {
            listElement.remove();
            if (noMessage) {
              noMessage.toggleAttribute('hidden', false);
            }
          } else if (listElement) {
            // Refresh the priority display
            refreshPriorityDisplay();
          }

          // Update the last updated timestamp
          updateLastUpdated();
        });
      };

      // Setup event listeners for existing items
      const items = container.querySelectorAll('.scl-priority-item');
      items.forEach(setupItemEventListeners);
    };

    // Initialize priority handlers when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      setupPriorityHandlers('#company-priorities-container', 'company_priority');
      setupPriorityHandlers('#hmg-priorities-container', 'hmg_priority');

      // Ensure initial state of "no priorities" messages is correct
      refreshPriorityDisplay();
    });

    // Function to refresh priority display across the page
    const refreshPriorityDisplay = () => {
      if (pageIsEditing) return; // Don't refresh during edit mode

      const containers = ['#company-priorities-container', '#hmg-priorities-container'];

      containers.forEach(containerSelector => {
        const container = document.querySelector(containerSelector);
        if (!container) return;

        const list = container.querySelector('.govuk-list');
        const noMessage = container.querySelector('[id^="no-"][id$="-priorities-message"]');

        // Update "no priorities" message visibility
        if (noMessage) {
          if (!list || !list.querySelectorAll('.scl-priority-item').length) {
            noMessage.toggleAttribute('hidden', false);
            if (list) list.remove();
            return;
          } else {
            noMessage.toggleAttribute('hidden', true);
          }
        }

        if (!list) return;

        const items = Array.from(list.querySelectorAll('.scl-priority-item'));
        const moreToggle = list.querySelector('.scl-priority-more-toggle');

        // Remove any existing "Show more" toggle
        if (moreToggle) {
          moreToggle.remove();
        }

        // If we have more than 5 priorities, add the toggle and hide extras
        if (items.length > 5) {
          // Hide priorities beyond the first 5
          items.forEach((item, index) => {
            if (index >= 5) {
              item.classList.add('scl-priority-item--beyond-initial');
              item.toggleAttribute('hidden', true);
            } else {
              item.classList.remove('scl-priority-item--beyond-initial');
              item.toggleAttribute('hidden', false);
            }
          });

          // Create and add the "Show more" toggle
          const newToggle = createElement('li', {
            className: 'scl-priority-more-toggle'
          });

          newToggle.dataset.moreText = 'Show all priorities';
          newToggle.dataset.lessText = 'Show fewer priorities';

          const toggleButton = createElement('button', {
            className: 'govuk-button govuk-button--secondary',
            textContent: 'Show all priorities'
          });

          newToggle.appendChild(toggleButton);

          // Insert after the 5th item
          if (items[4] && items[4].nextSibling) {
            list.insertBefore(newToggle, items[4].nextSibling);
          } else {
            list.appendChild(newToggle);
          }

          // Add toggle functionality
          const button = newToggle.querySelector('button');
          let isExpanded = false;

          button.addEventListener('click', () => {
            isExpanded = !isExpanded;
            button.textContent = isExpanded ? newToggle.dataset.lessText : newToggle.dataset.moreText;

            // Show/hide priorities beyond the first 5
            items.forEach((item, index) => {
              if (index >= 5) {
                item.toggleAttribute('hidden', !isExpanded);
              }
            });
          });
        } else {
          // Show all priorities if we have 5 or fewer
          items.forEach(item => {
            item.toggleAttribute('hidden', false);
          });
        }
      });
    };
  })();
</script>

<style nonce="{{request.csp_nonce}}">
.scl-priority-item {
  margin-bottom: 1.5rem;
  padding: 1rem;
  border: 1px solid #b1b4b6;
  list-style-type: none;
}

.govuk-list .scl-priority-item:before {
  content: none;
}

.scl-priority-actions {
  margin-top: 1rem;
  display: flex;
  gap: 0.5rem;
}

.scl-priority-actions--hidden {
  display: none;
}

.scl-priority-editing {
  margin-top: 1rem;
}

.scl-priority-more-toggle {
  margin: 1rem 0;
  list-style: none;
}

.govuk-list .scl-priority-more-toggle:before {
  content: none;
}

.govuk-button--warning {
  background-color: #d4351c;
}

.govuk-button--warning:hover {
  background-color: #aa2a16;
}

[hidden] {
  display: none !important;
}
</style>
{% endblock %}
