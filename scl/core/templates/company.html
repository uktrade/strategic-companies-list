{% extends "base.html" %} {% block content %}
<div class="govuk-width-container">
  <main class="govuk-main-wrapper" id="main-content">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-full">
        <div class="scl-content-header">
          <h1 class="govuk-heading-l scl-content-header__heading govuk-!-margin-bottom-2">{{ company.name }}</h1>
          <div>
            <button
              class="govuk-button scl-content-header__button govuk-!-margin-bottom-2"
              data-module="scl-edit-button"
              data-scl-edit-button-target=".scl-editable"
            >
              Edit
            </button>
            <button
              class="govuk-button scl-content-header__button govuk-!-margin-left-1 govuk-!-margin-bottom-2"
              data-module="scl-print-button"
            >
              Print
            </button>
          </div>
        </div>
        <p class="govuk-body govuk-body-s">Last updated: 28 Feb. 2025</p>
      </div>
    </div>
    <div class="govuk-grid-row">
      <section class="govuk-grid-column-two-thirds">
        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-!-margin-top-0">
        <h2 class="govuk-heading-m">Key facts</h2>
        <ul class="govuk-list govuk-list--bullet">
          <li>Largest UK company in the health sector.</li>
          <li>
            The company employs around 1000 in the UK and 7000 globally.
          </li>
          <li>
            Their activities in developing the skills of their workforce
            include: Science, Technology, Engineering and Math.
          </li>
        </ul>
        <h2 class="govuk-heading-m">Key people</h2>
        <ul class="govuk-list govuk-list--bullet">
          <li>Engineer: Mrs Jane Doe, appointed November 2022.</li>
          <li>Data Analyst: Mr John Smith, appointed October 2023.</li>
        </ul>
        {% if is_owner == 'true' %}
        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-section-break--visible govuk-!-margin-top-7 govuk-!-margin-bottom-0">
        <strong class="govuk-tag govuk-tag--red scl-tag scl-tag--security scl-tag--hanging">PRIVILEGED</strong>
        <h2 class="govuk-heading-m govuk-!-margin-top-3">Company current issues and priorities</h2>
        <ol class="govuk-list govuk-list--number scl-editable" data-scl-editable-field="company_priorities">
          {% if company.company_priorities %}
            {{ company.company_priorities | safe }}
          {% else %}
          <li>
            <b>Support key exports</b>
            <div>
              Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
              eiusmod tempor incididunt ut labore et dolore magna aliqua.
            </div>
          </li>
          <li>
            <b>Support programme.</b>
            <div>
              Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
              eiusmod tempor incididunt ut labore et dolore magna aliqua.
            </div>
          </li>
          <li>
            <b>International partnerships.</b>
            <div>
              Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
              eiusmod tempor incididunt ut labore et dolore magna aliqua.
            </div>
          </li>
          {% endif %}
        </ol>
        <h2 class="govuk-heading-m">HMG priorities for engagement</h2>
        <ol class="govuk-list govuk-list--number scl-editable" data-scl-editable-field="hmg_priorities">
          {% if company.hmg_priorities %}
            {{ company.hmg_priorities | safe }}
          {% else %}
          <li>
            <b>Growing exports</b>
            <div>
              Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
              eiusmod tempor incididunt ut labore et dolore magna aliqua.
            </div>
          </li>
          <li>
            <b>Building support programmes</b>
            <div>
              Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
              eiusmod tempor incididunt ut labore et dolore magna aliqua.
            </div>
          </li>
          <li>
            <b>Growing capabilities.</b>
            <div>
              Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
              eiusmod tempor incididunt ut labore et dolore magna aliqua.
            </div>
          </li>
          {% endif %}
        </ol>
        {% endif %}
      </section>
      <aside class="govuk-grid-column-one-third" role="complementary">
        <hr class="govuk-section-break govuk-section-break--m govuk-!-margin-top-0 govuk-section-break--visible govuk-!-margin-bottom-0">
        {% if is_owner == 'true' %}
        <strong class="govuk-tag govuk-tag--red scl-tag scl-tag--security scl-tag--hanging">PRIVILEGED</strong>
        <h2 class="govuk-heading-s govuk-!-margin-top-4 govuk-!-margin-bottom-2">
          Recent top-level engagements across HMG
        </h2>
        <ul class="scl-multiline-list govuk-!-margin-bottom-2">
          <li>
            <a href="/engagement" class="govuk-link govuk-link--no-visited-state scl-multiline-list__link">
              <strong class="govuk-tag govuk-tag--grey govuk-!-font-tabular-numbers scl-tag scl-tag--small scl-tag--date scl-multiline-list__date">1 Feb. 2025</strong>
              <span class="scl-multiline-list__link_text">UK manufacturing round table</span>
            </a
            >
          </li>
          <li>
            <a href="/engagement" class="govuk-link govuk-link--no-visited-state scl-multiline-list__link">
              <strong class="govuk-tag govuk-tag--grey govuk-!-font-tabular-numbers scl-tag scl-tag--small scl-tag--date scl-multiline-list__date">23 Jun. 2025</strong>
              <span class="scl-multiline-list__link_text">France meeting</span>
            </a>
          </li>
          <li>
            <a href="/engagement" class="govuk-link govuk-link--no-visited-state scl-multiline-list__link">
              <strong class="govuk-tag govuk-tag--grey govuk-!-font-tabular-numbers scl-tag scl-tag--small scl-tag--date scl-multiline-list__date">10 Dec. 2024</strong>
              <span class="scl-multiline-list__link_text">Italy meeting</span>
            </a>
          </li>
          <li>
            <a href="/engagement" class="govuk-link govuk-link--no-visited-state scl-multiline-list__link">
              <strong class="govuk-tag govuk-tag--grey govuk-!-font-tabular-numbers scl-tag scl-tag--small scl-tag--date scl-multiline-list__date">15 Nov. 2024</strong>
              <span class="scl-multiline-list__link_text">Aerospace round table</span>
            </a>
          </li>
        </ul>

        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-!-margin-top-1 govuk-!-margin-bottom-1">
        <p class="govuk-body govuk-!-margin-top-0 govuk-!-margin-bottom-0 scl-body--small"><a href="#" class="govuk-link govuk-link--no-visited-state scl-link--no-underline">View working-level engagements</a></p>
        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible govuk-!-margin-top-5 govuk-!-margin-bottom-2">
        {% endif %}
        <h2 class="govuk-heading-s govuk-!-margin-bottom-2 govuk-!-margin-top-{% if is_owner == 'true' %}2{% else %}4{% endif %}">Account managers</h2>
        {% if account_managers %}
          <ul class="govuk-list scl-list--small">
          {% for account_manager in account_managers %}
              <li><a class="govuk-link govuk-link--no-visited-state" href="##">{{ account_manager.first_name }} {{ account_manager.last_name }}</a></li>
          {% endfor %}
          </ul>
        {% else %}
            <p class="govuk-body govuk-!-margin-top-0 govuk-!-margin-bottom-0 scl-body--small">No account managers</p>
        {% endif %}
      </aside>
    </div>
  </main>
</div>
<script nonce="{{request.csp_nonce}}">
  (() => {
    const registerEditButton = (editButton) => {
      const editableSection = Array.from(document.querySelectorAll(editButton.getAttribute("data-scl-edit-button-target")));

      let isEditable = false

      const timeout = (duration) => {
        return new Promise(resolve => setTimeout(resolve, duration));
      }

      const minTimeFetch = async (minTime, resource, options) => {
        // Wraps fetch in an API where it has a minimum run time (in case it's really quick so
        // the user has a chance to see "Saving" or similar, and also avoids it from raising an
        // exception, so calling code doesn't need try/catch blocks
        const start = performance.now();
        let error = null;
        let response = null;

        try {
          response = await fetch(resource, options);
          if (!response.ok) {
            throw new Error();
          }
          ok = true;
        } catch (_error) {
          error = _error
        }

        const end = performance.now();
        await timeout(Math.max(750, performance.now() - start));

        return {error, response}
      }

      const toggleEdit = async () => {
        isEditable = !isEditable;
        editButton.innerHTML = (isEditable) ? "Save" : "Edit";
        editableSection.map((item) => {
          item.toggleAttribute('contenteditable', isEditable)
        });

        // Only try to save it it's not editable, i.e. we're saving
        if (isEditable) return;

        editButton.disabled = true;
        editButton.innerHTML = "Saving...";

        const data = {}
        editableSection.forEach((item) => {
          data[item.getAttribute('data-scl-editable-field')] = item.innerHTML
        });

        const {error, response} = await minTimeFetch(750, "/api/v1/company/{{ company.duns_number }}", {
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
          },
          method: "PATCH",
          body: JSON.stringify(data),
        })

        editButton.innerHTML = error ? 'Error!' : 'Saved';
        await timeout(750);

        editButton.disabled = false;
        editButton.innerHTML = "Edit";
      };

      editButton.addEventListener("click", toggleEdit);
    };

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('[data-module="scl-edit-button"]').forEach(registerEditButton);
    });
  })();

  (() => {
    const registerPrintButton = (printButton) => {
      printButton.addEventListener("click", () => window.print());
    };

    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('[data-module="scl-print-button"]').forEach(registerPrintButton);
    });
  })();
</script>
{% endblock %}
