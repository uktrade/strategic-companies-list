(()=>{const e=e=>new Promise((t=>setTimeout(t,e))),t=()=>document.querySelector("[data-scl-csrf-token]").getAttribute("data-scl-csrf-token"),o=async(t,o,i)=>{const r=performance.now();let n=null,a=null;try{if(a=await fetch(o,i),!a.ok)throw new Error}catch(e){n=e}return performance.now(),await e(Math.max(750,performance.now()-r)),{error:n,response:a}},i=i=>{let r=!1;const n=t();i.addEventListener("click",(async()=>{r=!r;const t={},a=i.getAttribute("data-scl-edit-id"),l=i.getAttribute("data-scl-edit-target"),s=i.getAttribute("data-scl-method"),c=i.getAttribute("data-scl-endpoint");i.innerHTML=r?"Save":"Edit";const d=Array.from(document.querySelectorAll(`[data-scl-edit-source="${l}"]`));if(d.map((e=>e.toggleAttribute("contenteditable",r))),r)return;i.disabled=!0,i.innerHTML="Saving...",d.forEach((e=>{t.id=a,t[e.getAttribute("data-scl-payload")]=e.innerHTML}));const{error:p,response:u}=await o(0,c,{headers:{"Content-Type":"application/json","X-CSRFToken":n},method:s,body:JSON.stringify(t)});i.innerHTML=p?"Error!":"Saved",await e(750),i.disabled=!1,i.innerHTML="Edit"}))},r=i=>{const r=t(),n=i.getAttribute("data-transcript-target"),a=i.getAttribute("data-scl-endpoint");i.addEventListener("click",(async()=>{i.innerHTML="Saving...";const t=document.querySelector(`#transcription-target-${n} p span`).innerHTML,{error:l,response:s}=await o(0,a,{headers:{"Content-Type":"application/json","X-CSRFToken":r},method:"POST",body:JSON.stringify({note:t})});i.innerHTML=l?"Error!":"Saved",await e(750),window.location.reload()}))},n=i=>{const r=t();noteId=i.getAttribute("data-scl-notes-id"),endPoint=i.getAttribute("data-scl-endpoint"),i.addEventListener("click",(async()=>{i.innerHTML="Deleting...";const{error:t,response:n}=await o(0,endPoint,{headers:{"Content-Type":"application/json","X-CSRFToken":r},method:"DELETE",body:JSON.stringify({id:noteId})});i.innerHTML=t?"Error!":"Deleted",await e(750),window.location.reload()}))},a=e=>{e.addEventListener("click",(()=>window.print()))};document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll('[data-module="scl-edit-button"]').forEach(i),document.querySelectorAll('[data-module="scl-save-transcript"]').forEach(r),document.querySelectorAll('[data-module="scl-delete-transcript"]').forEach(n),document.querySelectorAll('[data-module="scl-print-button"]').forEach(a)}))})(),(()=>{const e=document.querySelector("[data-scl-csrf-token]").getAttribute("data-scl-csrf-token"),t=e=>new Promise((t=>setTimeout(t,e))),o=async(e,o,i)=>{const r=performance.now();let n=null,a=null;try{if(a=await fetch(o,i),!a.ok)throw new Error}catch(e){n=e}return performance.now(),await t(Math.max(750,performance.now()-r)),{error:n,response:a}},i=(e,t={},o=[])=>{const i=document.createElement(e);return Object.entries(t).forEach((([e,t])=>{"className"===e?i.className=t:"textContent"===e?i.textContent=t:i.setAttribute(e,t)})),o.forEach((e=>{"string"==typeof e?i.appendChild(document.createTextNode(e)):i.appendChild(e)})),i},r=()=>{const e=document.getElementById("company-last-updated");if(e){const t=new Date,o=t.toLocaleString("en-US",{month:"long"}),i=t.getDate(),r=t.getFullYear(),n=t.getHours()%12||12,a=t.getMinutes().toString().padStart(2,"0"),l=t.getHours()>=12?"p.m.":"a.m.";e.textContent=`Last updated: ${o} ${i}, ${r}, ${n}:${a} ${l}`}};let n=!1;const a=document.querySelector('[data-module="scl-edit-button"]');if(a){const e=document.querySelectorAll(".scl-priority-actions"),t=document.querySelectorAll(".scl-priority-button--hidden"),o=document.querySelectorAll(".scl-priority-more-toggle"),i=()=>{e.forEach((e=>{e.classList.toggle("scl-priority-actions--hidden",!n)})),t.forEach((e=>{e.style.display=n?"inline-block":"none"})),n?(o.forEach((e=>{e.style.display="none"})),document.querySelectorAll(".scl-priority-item").forEach((e=>{e.style.display="list-item"}))):l()},l=()=>{["#company-priorities-container","#hmg-priorities-container"].forEach((e=>{const t=document.querySelector(e);if(!t)return;const o=t.querySelector(".govuk-list"),i=t.querySelector('[id^="no-"][id$="-priorities-message"]');if(!o&&t.querySelectorAll(".scl-priority-item").length>0){const o=document.createElement("ul");o.id=e.replace("#","")+"-list",o.className="govuk-list",t.querySelectorAll(".scl-priority-item").forEach((e=>o.appendChild(e)));const r=t.querySelector('[id^="add-"][id$="-priority-button"]');return r?t.insertBefore(o,r):t.appendChild(o),void(i&&(i.style.display="none"))}if(!o)return;const r=o.querySelectorAll(".scl-priority-item"),n=o.querySelector(".scl-priority-more-toggle");if(i&&(i.style.display=0===r.length?"block":"none"),0!==r.length)if(n&&n.remove(),r.length>5){r.forEach(((e,t)=>{e.style.display=t>=5?"none":"list-item"}));const e=document.createElement("li");e.className="scl-priority-more-toggle",e.dataset.moreText="Show all priorities",e.dataset.lessText="Show fewer priorities";const t=document.createElement("button");t.className="govuk-button govuk-button--secondary",t.textContent="Show all priorities",e.appendChild(t),r[4]&&r[4].nextSibling?o.insertBefore(e,r[4].nextSibling):o.appendChild(e);const i=e.querySelector("button");let n=!1;i.addEventListener("click",(()=>{n=!n,i.textContent=n?e.dataset.lessText:e.dataset.moreText,r.forEach(((e,t)=>{t>=5&&(e.style.display=n?"list-item":"none")}))}))}else r.forEach((e=>{e.style.display="list-item"}));else o.remove()}))};i(),a.addEventListener("click",(()=>{n=!n,i(),document.querySelectorAll(".scl-priority-actions").forEach((e=>{e.classList.toggle("scl-priority-actions--hidden",!n)})),n||(r(),["#company-priorities-container","#hmg-priorities-container"].forEach((e=>{const t=document.querySelector(e);if(!t)return;const o=t.querySelector(".govuk-list"),i=t.querySelector('[id^="no-"][id$="-priorities-message"]');o&&0!==o.querySelectorAll(".scl-priority-item").length||!i||(i.style.display="block",o&&o.remove())})),l())}))}const l=(a,l)=>{const c=document.querySelector(a);if(!c)return;const d=c.getAttribute("data-company-duns"),p=c.getAttribute("data-insight-type"),u=`${p.replace("_","-")}-list`,m=`no-${p.replace("_","-")}-message`,y=`add-${p.replace("_","-")}-button`,h=document.getElementById(u),g=document.getElementById(m),v=document.getElementById(y);v.addEventListener("click",(()=>{g&&(g.style.display="none");let e=h;e||(e=document.createElement("ul"),e.id=u,e.className="govuk-list",c.insertBefore(e,v));const t=document.createElement("li");t.className="scl-priority-item scl-priority-item--new";const o="new-priority-"+Date.now();t.setAttribute("data-temp-id",o);const r=i("div",{className:"scl-priority-editing"}),n=i("div",{className:"govuk-form-group"}),a=i("label",{className:"govuk-label",for:`${o}-title`},["Priority"]),l=i("input",{className:"govuk-input",id:`${o}-title`,name:"title",type:"text"});n.appendChild(a),n.appendChild(l);const s=i("div",{className:"govuk-form-group"}),m=i("label",{className:"govuk-label",for:`${o}-details`},["Details"]),y=i("textarea",{className:"govuk-textarea",id:`${o}-details`,name:"details",rows:"5"});s.appendChild(m),s.appendChild(y);const f=i("div",{className:"govuk-button-group"}),C=i("button",{className:"govuk-button scl-priority-save"},["Save"]),S=i("button",{className:"govuk-button govuk-button--secondary scl-priority-cancel"},["Cancel"]);f.appendChild(C),f.appendChild(S),r.appendChild(n),r.appendChild(s),r.appendChild(f),t.appendChild(r),e.appendChild(t),t.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout((()=>{l.focus()}),100),b(t,d,p)}));const b=(a,l,c)=>{const d=a.querySelector(".scl-priority-save"),p=a.querySelector(".scl-priority-cancel"),m=a.querySelector('input[name="title"]'),y=a.querySelector('textarea[name="details"]');p.addEventListener("click",(()=>{a.remove();const e=document.getElementById(u);e&&0===e.querySelectorAll(".scl-priority-item").length&&(e.remove(),g&&(g.style.display="block"))})),d.addEventListener("click",(async()=>{const p=m.value.trim(),u=y.value.trim();if(!p)return void alert("Please enter a title for the priority");d.textContent="Saving...",d.disabled=!0;const h=`/api/v1/company/${l}/insights/${c}`,{error:v,response:b}=await o(0,h,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":e},body:JSON.stringify({title:p,details:u})});if(v)return d.textContent="Error!",await t(750),d.textContent="Save",void(d.disabled=!1);const C=await b.json();for(a.setAttribute("data-priority-id",C.id),a.removeAttribute("data-temp-id"),a.classList.remove("scl-priority-item--new");a.firstChild;)a.removeChild(a.firstChild);const S=i("div",{className:"scl-priority-content"}),E=i("b",{className:"scl-priority-title"},[C.title]),k=i("div",{className:"scl-priority-details"});C.details.split("\n").forEach(((e,t,o)=>{k.appendChild(document.createTextNode(e)),t<o.length-1&&k.appendChild(document.createElement("br"))}));const N=i("p",{className:"govuk-body-s govuk-!-margin-top-1"},[`Added by ${C.created_by} on ${new Date(C.created_at).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}`]);S.appendChild(E),S.appendChild(k),S.appendChild(N);const w=i("div",{className:"scl-priority-actions "+(n?"":"scl-priority-actions--hidden")}),A=i("button",{className:"govuk-button govuk-button--secondary scl-button-edit-priority"},["Edit"]),q=i("button",{className:"govuk-button govuk-button--warning scl-button-delete-priority"},["Delete"]);w.appendChild(A),w.appendChild(q),a.appendChild(S),a.appendChild(w),f(a),g&&(g.style.display="none"),s(),r()}))},f=a=>{const l=a.querySelector(".scl-button-edit-priority"),c=a.querySelector(".scl-button-delete-priority"),d=a.getAttribute("data-priority-id");l.addEventListener("click",(async()=>{const l=a.querySelector(".scl-priority-title"),s=a.querySelector(".scl-priority-details"),c=l.textContent.trim();let p="";s&&Array.from(s.childNodes).forEach((e=>{e.nodeType===Node.TEXT_NODE?p+=e.textContent:"BR"===e.nodeName&&(p+="\n")})),a.setAttribute("data-original-structure","saved");const u=a.cloneNode(!0);for(;a.firstChild;)a.removeChild(a.firstChild);const m=i("div",{className:"scl-priority-editing"}),y=i("div",{className:"govuk-form-group"}),h=i("label",{className:"govuk-label",for:`edit-${d}-title`},["Priority"]),g=i("input",{className:"govuk-input",id:`edit-${d}-title`,name:"title",type:"text",value:c});y.appendChild(h),y.appendChild(g);const v=i("div",{className:"govuk-form-group"}),b=i("label",{className:"govuk-label",for:`edit-${d}-details`},["Details"]),C=i("textarea",{className:"govuk-textarea",id:`edit-${d}-details`,name:"details",rows:"5"});C.textContent=p.trim(),v.appendChild(b),v.appendChild(C);const S=i("div",{className:"govuk-button-group"}),E=i("button",{className:"govuk-button scl-priority-update"},["Save"]),k=i("button",{className:"govuk-button govuk-button--secondary scl-priority-cancel-edit"},["Cancel"]);S.appendChild(E),S.appendChild(k),m.appendChild(y),m.appendChild(v),m.appendChild(S),a.appendChild(m);const N=a.querySelector(".scl-priority-update");k.addEventListener("click",(()=>{for(;a.firstChild;)a.removeChild(a.firstChild);Array.from(u.childNodes).forEach((e=>{a.appendChild(e.cloneNode(!0))})),a.removeAttribute("data-original-structure"),f(a)})),N.addEventListener("click",(async()=>{const l=g.value.trim(),s=C.value.trim();if(!l)return void alert("Please enter a title for the priority");N.textContent="Saving...",N.disabled=!0;const c=`/api/v1/insights/${d}`,{error:p,response:u}=await o(0,c,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRFToken":e},body:JSON.stringify({title:l,details:s})});if(p)return N.textContent="Error!",await t(750),N.textContent="Save",void(N.disabled=!1);const m=await u.json();for(;a.firstChild;)a.removeChild(a.firstChild);const y=i("div",{className:"scl-priority-content"}),h=i("b",{className:"scl-priority-title"},[m.title]),v=i("div",{className:"scl-priority-details"});m.details.split("\n").forEach(((e,t,o)=>{v.appendChild(document.createTextNode(e)),t<o.length-1&&v.appendChild(document.createElement("br"))}));const b=i("p",{className:"govuk-body-s govuk-!-margin-top-1"},[`Added by ${m.created_by} on ${new Date(m.created_at).toLocaleDateString("en-GB",{day:"numeric",month:"short",year:"numeric"})}`]);y.appendChild(h),y.appendChild(v),y.appendChild(b);const S=i("div",{className:"scl-priority-actions "+(n?"":"scl-priority-actions--hidden")}),E=i("button",{className:"govuk-button govuk-button--secondary scl-button-edit-priority"},["Edit"]),k=i("button",{className:"govuk-button govuk-button--warning scl-button-delete-priority"},["Delete"]);S.appendChild(E),S.appendChild(k),a.appendChild(y),a.appendChild(S),f(a),r()}))})),c.addEventListener("click",(async()=>{if(!confirm("Are you sure you want to delete this priority?"))return;c.textContent="Deleting...",c.disabled=!0;const{error:i}=await o(0,`/api/v1/insights/${d}`,{method:"DELETE",headers:{"X-CSRFToken":e}});if(i)return c.textContent="Error!",await t(750),c.textContent="Delete",void(c.disabled=!1);a.remove();const n=document.getElementById(u);n&&0===n.querySelectorAll(".scl-priority-item").length?(n.remove(),g&&(g.style.display="block")):n&&s(),r()}))};c.querySelectorAll(".scl-priority-item").forEach(f)};document.addEventListener("DOMContentLoaded",(()=>{l("#company-priorities-container"),l("#hmg-priorities-container"),s()}));const s=()=>{n||["#company-priorities-container","#hmg-priorities-container"].forEach((e=>{const t=document.querySelector(e);if(!t)return;const o=t.querySelector(".govuk-list"),r=t.querySelector('[id^="no-"][id$="-priorities-message"]');if(r){if(!o||!o.querySelectorAll(".scl-priority-item").length)return r.style.display="block",void(o&&o.remove());r.style.display="none"}if(!o)return;const n=Array.from(o.querySelectorAll(".scl-priority-item")),a=o.querySelector(".scl-priority-more-toggle");if(a&&a.remove(),n.length>5){n.forEach(((e,t)=>{e.style.display=t>=5?"none":"list-item"}));const e=i("li",{className:"scl-priority-more-toggle"});e.dataset.moreText="Show all priorities",e.dataset.lessText="Show fewer priorities";const t=i("button",{className:"govuk-button govuk-button--secondary",textContent:"Show all priorities"});e.appendChild(t),n[4]&&n[4].nextSibling?o.insertBefore(e,n[4].nextSibling):o.appendChild(e);const r=e.querySelector("button");let a=!1;r.addEventListener("click",(()=>{a=!a,r.textContent=a?e.dataset.lessText:e.dataset.moreText,n.forEach(((e,t)=>{t>=5&&(e.style.display=a?"list-item":"none")}))}))}else n.forEach((e=>{e.style.display="list-item"}))}))}})();